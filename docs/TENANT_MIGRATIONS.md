# Управление миграциями тенантов

## Проблема
При добавлении новых миграций или изменении структуры базы данных, изменения применяются только к основной базе данных, но не к базам данных тенантов.

## Решение
Созданы специальные команды для управления миграциями всех тенантов.

## Команды

### 1. Проверка статуса миграций всех тенантов
```bash
php artisan tenants:migrate-status
```
Показывает статус миграций для всех активных тенантов.

### 2. Выполнение миграций для всех тенантов
```bash
php artisan tenants:migrate
```
Выполняет все pending миграции для всех активных тенантов.

### 3. Полное пересоздание БД тенантов
```bash
php artisan tenants:migrate --fresh
```
⚠️ **ОСТОРОЖНО!** Удаляет все данные и пересоздает структуру БД.

### 4. Создание нового тенанта
```bash
php artisan tenant:create "Название тенанта" "домен.example.com" "имя_базы_данных"
```
Создает новый тенант с базой данных и выполняет все миграции.

## Workflow при разработке

### При добавлении новых миграций:
1. Создайте миграцию в `database/migrations/tenant/`
2. Выполните миграции для всех тенантов:
   ```bash
   php artisan tenants:migrate
   ```

### При создании нового тенанта:
```bash
php artisan tenant:create "Новый клиент" "client.example.com" "client_db"
```

### При проверке состояния системы:
```bash
php artisan tenants:migrate-status
```

## Автоматизация

Для автоматического выполнения миграций тенантов после основных миграций, можно добавить в `composer.json`:

```json
{
    "scripts": {
        "post-migrate": "php artisan migrate:tenants-after-main"
    }
}
```

## Структура БД тенанта

Каждый тенант должен иметь следующие таблицы:
- `migrations` - таблица миграций
- `subscribers` - абоненты
- `meters` - счетчики
- `meter_readings` - показания счетчиков
- `invoices` - счета
- `payments` - платежи
- `services` - услуги

## Мониторинг

Регулярно проверяйте статус миграций:
```bash
php artisan tenants:migrate-status
```

Это поможет выявить тенантов с неполной структурой БД.
