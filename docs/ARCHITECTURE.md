# Архитектура Multi-Tenant CRM системы

## 1. Общая схема системы

```
┌─────────────────────────────────────────────────────────────┐
│                    Multi-Tenant CRM System                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   Central CRM   │    │   Tenant CRM    │                │
│  │                 │    │                 │                │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │                │
│  │ │ Admin Panel │ │    │ │ Tenant Panel│ │                │
│  │ │ (Filament)  │ │    │ │ (Filament)  │ │                │
│  │ └─────────────┘ │    │ └─────────────┘ │                │
│  │                 │    │                 │                │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │                │
│  │ │ Central DB  │ │    │ │ Tenant DB   │ │                │
│  │ │ (central_crm)│ │    │ │ (tenant_*)  │ │                │
│  │ └─────────────┘ │    │ └─────────────┘ │                │
│  └─────────────────┘    └─────────────────┘                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 2. Database-per-Tenant подход

### 2.1 Принцип работы

Каждый тенант (клиент) имеет:
- **Собственную базу данных** (`tenant_*`)
- **Изолированные данные** (полная изоляция)
- **Индивидуальные настройки** (в JSONB формате)

### 2.2 Преимущества

- ✅ **Максимальная безопасность** - данные полностью изолированы
- ✅ **Простота резервного копирования** - отдельная БД на тенанта
- ✅ **Масштабируемость** - можно переносить тенантов на разные серверы
- ✅ **Производительность** - нет cross-tenant запросов
- ✅ **Простота разработки** - нет необходимости в tenant_id в каждом запросе

### 2.3 Недостатки

- ❌ **Сложность миграций** - нужно обновлять все БД тенантов
- ❌ **Высокие требования к ресурсам** - много отдельных БД
- ❌ **Сложность аналитики** - данные разбросаны по БД

## 3. Две Filament панели

### 3.1 AdminPanelProvider (Центральная админка)

**Назначение**: Управление тенантами и системой в целом

**Доступ**: `/admin`

**Функции**:
- Создание новых тенантов
- Управление тенантами (редактирование, удаление)
- Корзина тенантов (мягкое удаление)
- Системные настройки

**Ресурсы**:
- `TenantResource` - управление тенантами
- `TenantTrashResource` - управление корзиной

### 3.2 TenantPanelProvider (CRM тенанта)

**Назначение**: Управление данными конкретного тенанта

**Доступ**: `/tenant/{tenant_id}/crm`

**Функции**:
- Управление абонентами
- Планируется: услуги, счета, платежи, отчеты

**Ресурсы**:
- `SubscriberResource` - управление абонентами

**Особенности**:
- Отключена аутентификация (планируется)
- Автоматическое переключение БД
- Изолированная среда для каждого тенанта

## 4. Middleware система

### 4.1 TenantDatabaseMiddleware

**Назначение**: Переключение подключения к БД тенанта

**Работа**:
1. Получает `tenant_id` из маршрута или сессии
2. Находит тенанта в центральной БД
3. Настраивает подключение к БД тенанта
4. Передает управление дальше

**Код**:
```php
class TenantDatabaseMiddleware
{
    public function handle($request, Closure $next)
    {
        $tenantId = $request->route('tenant_id') ?? session('tenant_id');
        
        if ($tenantId) {
            $tenant = Tenant::find($tenantId);
            $this->configureTenantDatabase($tenant);
        }
        
        return $next($request);
    }
}
```

### 4.2 TenantServiceProvider

**Назначение**: Обеспечение подключения к БД тенанта для всех запросов

**Работа**:
1. Выполняется на событии `app->booted()`
2. Проверяет наличие `tenant_id` в сессии
3. Настраивает подключение к БД тенанта
4. Обеспечивает работу Livewire компонентов

**Проблема**: Livewire запросы не проходят через middleware
**Решение**: Сервис провайдер настраивает БД для всех запросов

## 5. Сервисы

### 5.1 TenantService

**Назначение**: Бизнес-логика управления тенантами

**Методы**:
- `createTenant()` - создание нового тенанта
- `createTenantDatabase()` - создание БД для тенанта
- `runTenantMigrations()` - применение миграций
- `softDeleteTenant()` - мягкое удаление
- `restoreTenant()` - восстановление
- `forceDeleteTenant()` - полное удаление

**Особенности**:
- Использует PDO для создания/удаления БД (обход Laravel транзакций)
- Обработка ошибок с откатом изменений
- Логирование всех операций

## 6. Маршруты и их назначение

### 6.1 Центральная админка

```php
Route::get('/', function () {
    return redirect('/admin');
});

// Все маршруты админки обрабатываются Filament AdminPanelProvider
```

### 6.2 CRM тенанта

```php
Route::get('/tenant/{tenant_id}/crm/{path?}', function ($tenant_id, $path = null) {
    // 1. Находит тенанта в БД
    $tenant = Tenant::find($tenant_id);
    
    // 2. Сохраняет tenant_id в сессии
    session(['tenant_id' => $tenant_id]);
    
    // 3. Настраивает подключение к БД тенанта
    config(['database.connections.tenant' => [...]]);
    
    // 4. Перенаправляет на Filament панель тенанта
    return redirect('/tenant');
});
```

### 6.3 Обработка маршрутов

1. **Центральная админка**: Filament автоматически обрабатывает маршруты
2. **CRM тенанта**: Специальный маршрут настраивает окружение и перенаправляет

## 7. Структура базы данных

### 7.1 Центральная БД (central_crm)

```sql
-- Управление тенантами
tenants (id, name, domain, database, settings, status, deleted, timestamps)

-- Корзина тенантов
tenant_trash (id, tenant_id, deleted_by, deleted_at, deletion_reason, timestamps)

-- Пользователи системы
users (id, name, email, password, timestamps)

-- Системные таблицы Laravel
cache, jobs, migrations, password_reset_tokens, personal_access_tokens
```

### 7.2 БД тенанта (tenant_*)

```sql
-- Абоненты тенанта
subscribers (id, name, address, apartment_number, building_number, 
           phone, email, status, balance, registration_date, 
           additional_info, timestamps)

-- Системные таблицы Laravel
cache, jobs, migrations, password_reset_tokens, personal_access_tokens
```

## 8. Текущие ограничения

### 8.1 Аутентификация
- ❌ Нет аутентификации для пользователей тенантов
- ❌ Нет системы ролей и прав доступа
- ✅ Есть аутентификация для центральной админки

### 8.2 Функциональность
- ✅ Управление тенантами (100%)
- ✅ Управление абонентами (100%)
- ❌ Услуги, счета, платежи (0%)
- ❌ Отчеты и аналитика (0%)

### 8.3 Домены
- ❌ Нет работы с доменами/субдоменами
- ❌ Только маршруты с tenant_id
- ❌ Не готово для продакшена

### 8.4 API
- ❌ Нет REST API
- ❌ Нет документации API
- ❌ Нет аутентификации через API

## 9. Планы развития

### 9.1 Краткосрочные (1-2 недели)
1. Аутентификация для тенантов
2. Базовый функционал CRM (услуги, счета, платежи)
3. Dashboard с метриками

### 9.2 Среднесрочные (1-2 месяца)
1. Доменная архитектура
2. API для интеграций
3. Расширенная аналитика

### 9.3 Долгосрочные (3-6 месяцев)
1. Микросервисная архитектура
2. Мобильное приложение
3. Интеграция с внешними системами

## 10. Технические решения

### 10.1 Почему PostgreSQL?
- JSONB для гибких настроек
- Расширенные возможности
- Поддержка сложных запросов
- Надежность и производительность

### 10.2 Почему Filament?
- Быстрая разработка админ-панелей
- Встроенная система ресурсов
- Гибкая настройка интерфейса
- Активное сообщество

### 10.3 Почему Database-per-Tenant?
- Максимальная изоляция данных
- Простота резервного копирования
- Возможность масштабирования
- Соответствие требованиям безопасности

