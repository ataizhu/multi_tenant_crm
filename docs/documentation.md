# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Multi-Tenant CRM —Å–∏—Å—Ç–µ–º—ã

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### 1.1 –û–±—â–∞—è —Å—Ö–µ–º–∞

–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–µ **Database-per-Tenant** - –∫–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç (—Ç–µ–Ω–∞–Ω—Ç) –∏–º–µ–µ—Ç —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∏–∑–æ–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

### 1.2 –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: `central_crm` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å**: Filament AdminPanelProvider - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã —Å–∏—Å—Ç–µ–º—ã

#### –¢–µ–Ω–∞–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: `tenant_*` - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
- **CRM –ø–∞–Ω–µ–ª—å**: Filament TenantPanelProvider - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –ü–æ–∫–∞ –Ω–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

### 1.3 Middleware —Å–∏—Å—Ç–µ–º–∞

#### TenantDatabaseMiddleware
```php
// app/Http/Middleware/TenantDatabaseMiddleware.php
class TenantDatabaseMiddleware
{
    public function handle($request, Closure $next)
    {
        $tenantId = $request->route('tenant_id') ?? session('tenant_id');
        
        if ($tenantId) {
            $tenant = Tenant::find($tenantId);
            $this->configureTenantDatabase($tenant);
        }
        
        return $next($request);
    }
}
```

#### TenantServiceProvider
```php
// app/Providers/TenantServiceProvider.php
class TenantServiceProvider extends ServiceProvider
{
    public function boot()
    {
        app()->booted(function () {
            $tenantId = session('tenant_id');
            if ($tenantId) {
                $tenant = Tenant::find($tenantId);
                if ($tenant) {
                    $this->configureTenantDatabase($tenant);
                }
            }
        });
    }
}
```

### 1.4 –°–µ—Ä–≤–∏—Å—ã

#### TenantService
```php
// app/Services/TenantService.php
class TenantService
{
    public function createTenant(array $data): Tenant
    public function createTenantDatabase(Tenant $tenant): void
    public function runTenantMigrations(Tenant $tenant): void
    public function softDeleteTenant(Tenant $tenant, ?string $reason = null): void
    public function restoreTenant(Tenant $tenant): void
    public function forceDeleteTenant(Tenant $tenant): void
}
```

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 2.1 –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (central_crm)

#### –¢–∞–±–ª–∏—Ü–∞ tenants
- `id` - ID —Ç–µ–Ω–∞–Ω—Ç–∞
- `name` - –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- `domain` - –î–æ–º–µ–Ω —Ç–µ–Ω–∞–Ω—Ç–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `database` - –ò–º—è –ë–î —Ç–µ–Ω–∞–Ω—Ç–∞ (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ)
- `settings` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ JSONB —Ñ–æ—Ä–º–∞—Ç–µ
- `status` - –°—Ç–∞—Ç—É—Å (active/inactive/suspended)
- `deleted` - –§–ª–∞–≥ –º—è–≥–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
- `timestamps` - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

#### –¢–∞–±–ª–∏—Ü–∞ tenant_trash
- `id` - ID –∑–∞–ø–∏—Å–∏ –∫–æ—Ä–∑–∏–Ω—ã
- `tenant_id` - –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–Ω–∞–Ω—Ç–∞
- `deleted_by` - –ö—Ç–æ —É–¥–∞–ª–∏–ª
- `deleted_at` - –ö–æ–≥–¥–∞ —É–¥–∞–ª–µ–Ω
- `deletion_reason` - –ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è
- `timestamps` - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

#### –¢–∞–±–ª–∏—Ü–∞ users
- `id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `name` - –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `email` - Email (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `password` - –•—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
- `timestamps` - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

### 2.2 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–∞ (tenant_*)

#### –¢–∞–±–ª–∏—Ü–∞ subscribers
- `id` - ID –∞–±–æ–Ω–µ–Ω—Ç–∞
- `name` - –§–ò–û –∞–±–æ–Ω–µ–Ω—Ç–∞
- `address` - –ê–¥—Ä–µ—Å
- `apartment_number` - –ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã
- `building_number` - –ù–æ–º–µ—Ä –¥–æ–º–∞
- `phone` - –¢–µ–ª–µ—Ñ–æ–Ω
- `email` - Email
- `status` - –°—Ç–∞—Ç—É—Å –∞–±–æ–Ω–µ–Ω—Ç–∞
- `balance` - –ë–∞–ª–∞–Ω—Å
- `registration_date` - –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `additional_info` - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (JSONB)
- `timestamps` - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

## 3. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

### 3.1 –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞

1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `tenants`
2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ë–î `tenant_*`
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è –ë–î —Ç–µ–Ω–∞–Ω—Ç–∞
4. –¢–µ–Ω–∞–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### 3.2 –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞

1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ `deleted = true` –≤ —Ç–∞–±–ª–∏—Ü–µ `tenants`
2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `tenant_trash`
3. –ë–î —Ç–µ–Ω–∞–Ω—Ç–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç–æ–π

### 3.3 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞

1. –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ `deleted = false` –≤ —Ç–∞–±–ª–∏—Ü–µ `tenants`
2. –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `tenant_trash`

### 3.4 –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞

1. –£–¥–∞–ª–µ–Ω–∏–µ –ë–î —Ç–µ–Ω–∞–Ω—Ç–∞
2. –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `tenant_trash`
3. –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `tenants`

## 4. –ú–∞—Ä—à—Ä—É—Ç—ã

### 4.1 –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞
- `/admin` - –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–¥–º–∏–Ω–∫–∏
- `/admin/tenants` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏
- `/admin/tenant-trashes` - –ö–æ—Ä–∑–∏–Ω–∞ —Ç–µ–Ω–∞–Ω—Ç–æ–≤

### 4.2 CRM —Ç–µ–Ω–∞–Ω—Ç–∞
- `/tenant/{tenant_id}/crm` - –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ CRM
- `/tenant/{tenant_id}/crm/tenant/subscribers` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏

## 5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 5.1 –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

- –ö–∞–∂–¥—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–º–µ–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ë–î
- Middleware –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –º–µ–∂–¥—É —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏

### 5.2 –ë–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –∞–¥–º–∏–Ω–∫–∏
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —Ç–µ–Ω–∞–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

## 6. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 6.1 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- PHP 8.2+
- PostgreSQL 13+
- Composer
- Node.js & NPM

### 6.2 –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
5. –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
6. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

### 6.3 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```sql
CREATE DATABASE central_crm;
CREATE USER postgres WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE central_crm TO postgres;
```

## 7. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### 7.1 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏
- ‚úÖ –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
- ‚úÖ –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å –ë–î
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏
- ‚úÖ –î–≤–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ Filament –ø–∞–Ω–µ–ª–∏
- ‚úÖ Middleware –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ë–î

### 7.2 –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- üîÑ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —Ç–µ–Ω–∞–Ω—Ç–æ–≤
- üîÑ –£—Å–ª—É–≥–∏ –∏ —Ç–∞—Ä–∏—Ñ—ã
- üîÑ –°—á–µ—Ç–∞ –∏ –ø–ª–∞—Ç–µ–∂–∏
- üîÑ –û—Ç—á–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- üîÑ API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- üîÑ –î–æ–º–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## 8. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
app/
‚îú‚îÄ‚îÄ Filament/Resources/
‚îÇ   ‚îú‚îÄ‚îÄ TenantResource.php              # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ TenantTrashResource.php         # –ö–æ—Ä–∑–∏–Ω–∞ —Ç–µ–Ω–∞–Ω—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ Tenant/
‚îÇ       ‚îî‚îÄ‚îÄ SubscriberResource.php      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç–∞–º–∏
‚îú‚îÄ‚îÄ Http/Middleware/
‚îÇ   ‚îî‚îÄ‚îÄ TenantDatabaseMiddleware.php    # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ë–î
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ Tenant.php                      # –ú–æ–¥–µ–ª—å —Ç–µ–Ω–∞–Ω—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ TenantTrash.php                 # –ú–æ–¥–µ–ª—å –∫–æ—Ä–∑–∏–Ω—ã
‚îÇ   ‚îú‚îÄ‚îÄ User.php                        # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ Subscriber.php                  # –ú–æ–¥–µ–ª—å –∞–±–æ–Ω–µ–Ω—Ç–∞
‚îú‚îÄ‚îÄ Providers/
‚îÇ   ‚îî‚îÄ‚îÄ TenantServiceProvider.php       # –°–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä
‚îî‚îÄ‚îÄ Services/
    ‚îî‚îÄ‚îÄ TenantService.php               # –õ–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏

database/
‚îú‚îÄ‚îÄ migrations/                         # –ú–∏–≥—Ä–∞—Ü–∏–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ create_tenants_table.php
‚îÇ   ‚îî‚îÄ‚îÄ create_users_table.php
‚îî‚îÄ‚îÄ migrations/tenant/                  # –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ë–î —Ç–µ–Ω–∞–Ω—Ç–æ–≤
    ‚îî‚îÄ‚îÄ create_subscribers_table.php
```